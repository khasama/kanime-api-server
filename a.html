<!-- <form action="http://localhost:3456/api/v1/anime/" method="post" enctype="multipart/form-data">
    <input type="text" name="name" placeholder="name"> <br>
    <input type="text" name="othername" placeholder="othername"> <br>
    <input type="text" name="content" placeholder="content"> <br>
    <input type="number" name="year" placeholder="year"><br>
    <input type="file" name="image" accept="image/png, image/gif, image/jpeg"><br>
    <input type="file" name="imagebg" accept="image/png, image/gif, image/jpeg"><br>
    <button type="submit">submit</button>
</form> -->

<hr>

<div style="display: flex;">
    <div>
        <input type="text" name="name" placeholder="name" id="uname"> <br>
        <input type="text" name="othername" placeholder="othername" id="uothername"> <br>
        <input type="text" name="content" placeholder="content" id="ucontent"> <br>
        <input type="number" name="year" placeholder="year" id="uyear"><br>
        <input type="number" name="view" placeholder="view" id="uview"><br>
        <input type="number" name="liked" placeholder="liked" id="uliked"><br>
        <input type="number" name="mainserver" placeholder="mainserver" id="umainserver"><br>
        <input type="number" name="status" placeholder="status" id="ustatus"><br>
        <input type="file" name="nimage" id="uimage"><br>
        <img src="" alt="" id="img" width="100"> <br>
        <input type="file" name="nimagebg" id="uimagebg"><br>
        <img src="" alt="" id="imgbg" width="300"> <br>
        <input type="hidden" name="image" id="cimage"> 
        <input type="hidden" name="imagebg" id="cimagebg">

        <div class="genre-list" id="list">

        </div>

        <button id="btn-update">
            Update
        </button>
        <p>
            Phần: <span id="anime-season"></span> -- Series: <span id="anime-series"></span>
            <button id="detele-season" onclick="deleteSeason(this)">Remove</button>
        </p>
    </div>

    <div >
        <div id="genres">

        </div>

        <hr>

        <div>
            <h4 style="margin: 0;">Series</h4>
            <div>
                Add
                <input type="text" placeholder="Series" id="input-series">
                <button id="add-series">Add</button>
                |
                Update
                <select name="" id="series-list-a"></select>
                <input type="text" placeholder="Series" id="input-useries">
                <button id="update-series">Update</button>
                |
                Delete
                <select name="" id="series-list-b"></select>
                <button id="detele-series">Delete</button>
            </div>

            <div id="series"></div>

        </div>

        <hr>

        <div>
            <span>Add season: </span>
            <select name="" id="select-series">
            </select>
            <input type="text" name="" id="season" placeholder="Season">
            <button id="add-season" >Add</button>
        </div>

        <hr>

        <div>
            <h4 style="margin: 0;">Server</h4>
            <div>
                Add
                <input type="text" placeholder="Server" id="input-server">
                <input type="text" placeholder="Server description" id="input-description">
                <button id="add-server">Add</button>
                |
                Update
                <select name="" id="server-list-a"></select>
                <input type="text" placeholder="Server" id="input-userver">
                <input type="text" placeholder="Server description" id="input-udescription">
                <button id="update-server">Update</button>
                |
                Delete
                <select name="" id="server-list-b"></select>
                <button id="detele-server">Delete</button>
            </div>

            <div id="servers"></div>
        </div>
        <hr>
        <div>
            <table style="border: 1px solid;width: 100%;">
                <thead>
                    <tr>
                        <th style="border: 1px solid; width: 10%;">Episode</th>
                        <th style="border: 1px solid;">Information: <span id="anime-name"></span></th>
                    </tr>
                </thead>

                <tbody>
                    <tr style="height: 500px;">
                       <td id="full-episode" style="border: 1px solid; height: 100%; overflow-y: scroll;">
                       </td> 

                       <td>
                            <div style="width:100%; height: 500px; display: none;" id="episode-infor">
                                <div style="display: flex;">
                                    <iframe src="" 
                                        frameborder="0" allowfullscreen id="player" frameborder="0" width="50%" height="320px">
                                    </iframe>
                                    <div style="padding: 5px;">
                                        Server: <input type="text" name="" id="ep-server" disabled style="margin-bottom: 5px;"> <br>
                                        Episode: <input type="text" name="" id="episode" disabled style="margin-bottom: 5px;"> <br>
                                        Link: <input type="text" name="" id="link" style="margin-bottom: 5px;"> <br>
                                        <input type="hidden" id="id-ep">
                                        <button id="update-link">Update</button> | <button id="delete-link">Delete</button>
        
                                    </div>
                                </div>
                                <hr>
                                <div id="server-list-c">
                                    
                                </div>
                                <hr>
                                <div>
                                    <select name="" id="server-list-d"></select>
                                    <input type="text" id="link-input" placeholder="Link">
                                    <button id="add-link">Add</button> |
                                </div>
                                
                            </div>
                       </td>
                    </tr>
                    <tr>
                        <td colspan="2" style="border: 1px solid; text-align: center;">
                            <a href="javascript:void(0)">Thêm</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>
</div>



<script>
    const idAnime = 119;
    getSeason();
    getSeries();
    getServer();
    fetch(`http://localhost:3456/api/v1/anime/${idAnime}`)
    .then(response => response.json())
    .then(data => {
        const anime = data.data;
        setData(anime);
    });

    fetch('http://localhost:3456/api/v1/genre/all')
    .then(response => response.json())
    .then(data => {
        const genre = data.data;
        const genres = document.getElementById("genres");
        genre.forEach(ele => {
            genres.insertAdjacentHTML('beforeend', `
                <a href="javascript:void(0)" onclick="addGenre(this)" data-id="${ele.idGenre}" style="margin-right:10px;">${ele.Genre}</a> 
                `
            );
        });
    });

    function getSeason(){
        fetch(`http://localhost:3456/api/v1/season/${idAnime}`)
        .then(response => response.json())
        .then(data => {
            if(data.message == "Failed"){
                document.getElementById("anime-season").innerText = "None";
                document.getElementById("anime-series").innerText = "None";
                document.getElementById("detele-season").style.display = "None";
            }
            else{
                const s = data.data[0];
                document.getElementById("anime-season").innerText = s.Season;
                document.getElementById("anime-series").innerText = s.Series;
                document.getElementById("detele-season").style.display = "Block";
                document.getElementById("detele-season").setAttribute("data-id", s.idSeason);
            }
        });
    }

    function getServer(){
        fetch(`http://localhost:3456/api/v1/server/all`)
        .then(response => response.json())
        .then(data => {
            const server = data.data;
            const serverList = document.getElementById("servers");
            const a = document.getElementById("server-list-a");
            const b = document.getElementById("server-list-b");
            const d = document.getElementById("server-list-d");
            
            serverList.innerHTML = "";
            a.innerHTML = "";
            b.innerHTML = "";
            d.innerHTML = "";
            
            server.forEach(ele => {
                serverList.insertAdjacentHTML('beforeend', `
                    <a href="javascript:void(0)" style="margin-right:10px;" title="${ele.ServerDescription}" >${ele.Server}</a> 
                    `
                );

                a.insertAdjacentHTML('beforeend', `<option value="${ele.idServer}">${ele.Server}</option>`);
                b.insertAdjacentHTML('beforeend', `<option value="${ele.idServer}">${ele.Server}</option>`);
                d.insertAdjacentHTML('beforeend', `<option value="${ele.idServer}">${ele.Server}</option>`);
                
            });
        });
    }

    function getSeries(){
        fetch('http://localhost:3456/api/v1/series/all')
        .then(response => response.json())
        .then(data => {
            const seri = data.data;
            const series = document.getElementById("series");
            const a = document.getElementById("select-series");
            const b = document.getElementById("series-list-a");
            const c = document.getElementById("series-list-b");
            series.innerHTML = '';
            a.innerHTML = '';
            b.innerHTML = '';
            c.innerHTML = '';
            seri.forEach(ele => {
                series.insertAdjacentHTML('beforeend', `
                    <a href="javascript:void(0)" onclick="addSeries(this)" data-id="${ele.idSeries}" style="margin-right:10px;">${ele.Series}</a> 
                    `
                );
                a.insertAdjacentHTML('beforeend', `
                    <option value="${ele.idSeries}">${ele.Series}</option> 
                    `
                );
                b.insertAdjacentHTML('beforeend', `
                    <option value="${ele.idSeries}">${ele.Series}</option> 
                    `
                );
                c.insertAdjacentHTML('beforeend', `
                    <option value="${ele.idSeries}">${ele.Series}</option> 
                    `
                );
            });
        });
    }

    document.querySelector("#btn-update").addEventListener('click', () => {
        
        const formData = new FormData();
        const image = document.querySelector('#uimage');
        const imagebg = document.querySelector('#uimagebg');

        formData.append('name', document.getElementById("uname").value);
        formData.append('othername', document.getElementById("uothername").value);
        formData.append('content', document.getElementById("ucontent").value);
        formData.append('year', document.getElementById("uyear").value);
        formData.append('view', document.getElementById("uview").value);
        formData.append('liked', document.getElementById("uliked").value);
        formData.append('mainserver', document.getElementById("umainserver").value);
        formData.append('status', document.getElementById("ustatus").value);
        formData.append('imagebg', document.getElementById("cimagebg").value);
        formData.append('image', document.getElementById("cimage").value);

        if(image.files[0] != undefined){
            formData.append('nimage', image.files[0]);
        }
        if(imagebg.files[0] != undefined){
            formData.append('nimagebg', imagebg.files[0]);
        }

        fetch(`http://localhost:3456/api/v1/anime/update/${idAnime}`, {
            method: 'PUT',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            const anime = result.data;
            alert(result.message);
            setData(anime);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);

    function deleteGenre(ele){
        const idGA = ele.getAttribute('data-id');
        fetch('http://localhost:3456/api/v1/anime/delete-genre', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({idGA, idAnime})
        })
        .then(response => response.json())
        .then(result => {
            const anime = result.data;
            alert(result.message);
            setData(anime);
            
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function setData(anime){
        const url = "http://localhost:3456/public/anime/"
        document.getElementById("uname").value = anime.Name;
        document.getElementById("anime-name").innerText = anime.Name;
        document.getElementById("uothername").value = anime.OtherName;
        document.getElementById("ucontent").value = anime.Content;
        document.getElementById("uyear").value = anime.idYear;
        document.getElementById("uview").value = anime.View;
        document.getElementById("uliked").value = anime.Liked;
        document.getElementById("umainserver").value = anime.MainServer;
        document.getElementById("ustatus").value = anime.idStatus;
        document.getElementById("cimage").value = anime.Image;
        document.getElementById("cimagebg").value = anime.ImageBG;
        document.querySelector("#img").setAttribute("src", url+anime.Image);
        document.querySelector("#imgbg").setAttribute("src", url+anime.ImageBG);
        const list = document.getElementById("list");
        list.innerHTML = '';
        anime.Genre.forEach(ele => {
            list.insertAdjacentHTML('beforeend', `
                <a href="javascript:void(0)" class="genre-item" onclick="deleteGenre(this)" data-id="${ele.idGA}">${ele.Genre}</a> 
                `
            );
        });

        getEp(idAnime, anime.MainServer);
    }

    function addGenre(ele){
        const idGenre = ele.getAttribute('data-id');
        fetch('http://localhost:3456/api/v1/anime/add-genre', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({anime:idAnime, genre:idGenre})
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                const anime = result.data;
                alert(result.message);
                setData(anime);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    document.querySelector("#add-season").addEventListener('click', () => {
        const idSeries = document.getElementById("select-series").value;
        const season = document.getElementById("season").value;
        fetch('http://localhost:3456/api/v1/season/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({idAnime, idSeries, season})
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                getSeason();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);
    
    function deleteSeason(ele){
        const id = ele.getAttribute("data-id");
        fetch(`http://localhost:3456/api/v1/season/delete/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Success"){
                alert(result.message);
                getSeason();
            }
            
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    document.querySelector("#add-series").addEventListener('click', () => {
        const series = document.getElementById("input-series").value;
        fetch('http://localhost:3456/api/v1/series/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({series})
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                getSeries();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false)

    document.querySelector("#detele-series").addEventListener('click', () => {
        const idSeries = document.getElementById("series-list-b").value;
        fetch(`http://localhost:3456/api/v1/series/delete/${idSeries}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                getSeries();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);

    document.querySelector("#add-server").addEventListener('click', () => {
        const server = document.getElementById("input-server").value;
        const description = document.getElementById("input-description").value;
        fetch('http://localhost:3456/api/v1/server/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({server, description})
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                getServer();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);

    document.querySelector("#update-server").addEventListener('click', () => {
        const id = document.getElementById("server-list-a").value;
        const server = document.getElementById("input-userver").value;
        const description = document.getElementById("input-udescription").value;
        fetch(`http://localhost:3456/api/v1/server/update/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({server, description})
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                getServer();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);

    document.querySelector("#update-series").addEventListener('click', () => {
        const id = document.getElementById("series-list-a").value;
        const series = document.getElementById("input-useries").value;
        fetch(`http://localhost:3456/api/v1/series/update/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({series})
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                getSeries();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);

    document.querySelector("#detele-server").addEventListener('click', () => {
        const id = document.getElementById("server-list-b").value;
        fetch(`http://localhost:3456/api/v1/server/delete/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                getServer();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);

</script>

<script>
    function getEp(idAnime, idServer){
        const tbb = document.querySelector("#full-episode");
        fetch(`http://localhost:3456/api/v1/episode/get-ep/${idAnime}-${idServer}`)
        .then(response => response.json())
        .then(result => {
            const eps = result.data;
            console.log(eps);
            eps.forEach(ele => {
                tbb.insertAdjacentHTML('beforeend', 
                `<a href='javascript:void(0)' data-anime='${idAnime}' data-episode='${ele.Episode}' onclick='getFullUrl(this, ${JSON.stringify(ele)})'
                    style='display: block;text-align: center;border-bottom: 1px solid;'>
                    ${ele.Episode}
                </a>`);
            });
            
        })
        .catch(error => {
            console.log('Error:', error);
        });
    }

    function getFullUrl(ele, data){
        const anime = ele.getAttribute("data-anime");
        const episode = ele.getAttribute("data-episode");
        fetch(`http://localhost:3456/api/v1/episode/get-furl/${anime}-${episode}`)
        .then(response => response.json())
        .then(result => {
            const rs =result.data;
            setEpisodeInfor(rs, data);
        })
        .catch(err => {
            console.log(err);
        })

    }

    function setEpisodeInfor(rs, data){
        document.getElementById("episode-infor").style.display = "block";
        document.getElementById("ep-server").value = data.Server;
        document.getElementById("episode").value = data.Episode;
        document.getElementById("id-ep").value = data.idEpisode;
        document.getElementById("link").value = data.Link;
        document.getElementById("player").setAttribute("src", data.Link);
        const c = document.getElementById("server-list-c");
        c.innerHTML = "";
        rs.forEach(ele => {
            c.insertAdjacentHTML('beforeend', `
                <a href="javascript:void(0)" data-id="${ele.idEpisode}" onclick='changeServer(this)'
                    style="border: 1px solid; margin-right: 5px; padding: 5px 8px">
                    ${ele.Server}
                </a>
                `
            );
        });
    }

    document.querySelector("#update-link").addEventListener('click', () => {
        const id = document.getElementById("id-ep").value;
        const link = document.getElementById("link").value;
        fetch(`http://localhost:3456/api/v1/episode/update/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({link})
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                document.getElementById("link").value = link;
                document.getElementById("player").setAttribute("src", link);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);

    document.querySelector("#add-link").addEventListener('click', () => {
        const server = document.getElementById("server-list-d").value;
        const episode = document.getElementById("episode").value;
        const link = document.getElementById("link-input").value;
        fetch(`http://localhost:3456/api/v1/episode/add/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({anime: idAnime, server, episode, link})
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                fetch(`http://localhost:3456/api/v1/episode/get-furl/${idAnime}-${episode}`)
                .then(response => response.json())
                .then(res => {
                    const rs = res.data;
                    const c = document.getElementById("server-list-c");
                    c.innerHTML = "";
                    rs.forEach(ele => {
                        c.insertAdjacentHTML('beforeend', `
                            <a href="javascript:void(0)" data-id="${ele.idEpisode}" onclick='changeServer(this)'
                                style="border: 1px solid; margin-right: 5px; padding: 5px 8px">
                                ${ele.Server}
                            </a>
                            `
                        );
                    });
                })
                .catch(err => {
                    console.log(err);
                })
                
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }, false);

    function changeServer(ele) {
        const id = ele.getAttribute("data-id");
        fetch(`http://localhost:3456/api/v1/episode/get-link/${id}`)
        .then(response => response.json())
        .then(result => {
            const data = result.data[0];
            document.getElementById("ep-server").value = data.Server;
            document.getElementById("id-ep").value = data.idEpisode;
            document.getElementById("link").value = data.Link;
            document.getElementById("player").setAttribute("src", data.Link);
        })
        .catch(err => {
            console.log(err);
        })
    }

    document.querySelector("#delete-link").addEventListener('click', () => {
        const id = document.getElementById("id-ep").value;
        fetch(`http://localhost:3456/api/v1/episode/delete/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if(result.message == "Failed"){
                alert(result.error);
            }else{
                alert(result.message);
                document.getElementById("link").value = link;
                document.getElementById("player").setAttribute("src", link);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });

    }, false);
</script>